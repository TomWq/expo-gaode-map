# æµ‹è¯•ä¸è´¨é‡ä¿è¯

expo-gaode-map æ‹¥æœ‰å®Œå–„çš„å•å…ƒæµ‹è¯•ä½“ç³»ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œç¨³å®šæ€§ã€‚

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡

å½“å‰æµ‹è¯•è¦†ç›–ç‡ï¼š**75.7%** âœ…

```
-------------------------|---------|----------|---------|---------|-------------------
File                     | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
-------------------------|---------|----------|---------|---------|-------------------
All files                |    75.7 |    72.89 |    87.5 |   75.14 |
 src                     |   55.78 |    41.46 |   71.42 |   54.83 |
  ExpoGaodeMapModule.ts  |   70.68 |    60.71 |   91.66 |   70.68 |
  ExpoGaodeMapView.tsx   |   32.43 |        0 |   44.44 |   28.57 |
 src/components/overlays |      96 |    82.14 |     100 |      96 |
  Circle.tsx             |     100 |      100 |     100 |     100 |
  Cluster.tsx            |     100 |      100 |     100 |     100 |
  HeatMap.tsx            |     100 |      100 |     100 |     100 |
  Marker.tsx             |    92.3 |    82.14 |     100 |    92.3 |
  MultiPoint.tsx         |     100 |      100 |     100 |     100 |
  Polygon.tsx            |     100 |      100 |     100 |     100 |
  Polyline.tsx           |     100 |      100 |     100 |     100 |
 src/utils               |     100 |      100 |     100 |     100 |
  ErrorHandler.ts        |     100 |      100 |     100 |     100 |
  ModuleLoader.ts        |     100 |      100 |     100 |     100 |
-------------------------|---------|----------|---------|---------|-------------------

Test Suites: 12 passed, 12 total
Tests:       207 passed, 207 total
Snapshots:   0 total
Time:        0.996 s
```

## âœ… æµ‹è¯•èŒƒå›´

### æ ¸å¿ƒæ¨¡å—æµ‹è¯•

#### ExpoGaodeMapModuleï¼ˆ91.66% å‡½æ•°è¦†ç›–ç‡ï¼‰

**åŸºç¡€åŠŸèƒ½æµ‹è¯•**ï¼ˆ72ä¸ªæµ‹è¯•ï¼‰
- âœ… SDK åˆå§‹åŒ–å’Œç‰ˆæœ¬è·å–
- âœ… éšç§åˆè§„ç®¡ç†
- âœ… å®šä½æ§åˆ¶ï¼ˆå¯åŠ¨ã€åœæ­¢ã€æ£€æŸ¥çŠ¶æ€ï¼‰
- âœ… å•æ¬¡å®šä½å’Œè¿ç»­å®šä½
- âœ… åæ ‡è½¬æ¢ï¼ˆæ”¯æŒæ‰€æœ‰åæ ‡ç³»ï¼‰
- âœ… æƒé™æ£€æŸ¥å’Œè¯·æ±‚
- âœ… å®šä½ç›‘å¬å™¨ç®¡ç†

**é…ç½®é€‰é¡¹æµ‹è¯•**ï¼ˆæ‰€æœ‰ set* æ–¹æ³•ï¼‰
- âœ… Android é…ç½®ï¼ˆå®šä½æ¨¡å¼ã€ä¼ æ„Ÿå™¨ã€WiFiã€GPSä¼˜å…ˆç­‰ï¼‰
- âœ… iOS é…ç½®ï¼ˆç²¾åº¦ã€è·ç¦»è¿‡æ»¤ã€åå°å®šä½ç­‰ï¼‰
- âœ… é€šç”¨é…ç½®ï¼ˆé—´éš”ã€è¶…æ—¶ã€è¯­è¨€ç­‰ï¼‰

**æ·±åº¦æµ‹è¯•**ï¼ˆ43ä¸ªæµ‹è¯• - æ–°å¢ï¼‰
- âœ… **é”™è¯¯åœºæ™¯æµ‹è¯•**ï¼šSDKæœªåˆå§‹åŒ–ã€æ— æ•ˆå‚æ•°ã€æƒé™æ‹’ç»
- âœ… **è¾¹ç•Œå€¼æµ‹è¯•**ï¼šæ•°å€¼å‚æ•°è¾¹ç•Œã€æšä¸¾å€¼ã€å­—ç¬¦ä¸²å‚æ•°
- âœ… **é…ç½®ç»„åˆæµ‹è¯•**ï¼šAndroid/iOSå®Œæ•´é…ç½®é“¾ã€ä¸åŒå®šä½åœºæ™¯
- âœ… **ç”Ÿå‘½å‘¨æœŸæµ‹è¯•**ï¼šå®Œæ•´çš„å®šä½æµç¨‹ã€ç›‘å¬å™¨ç®¡ç†
- âœ… **å¼‚æ­¥æ“ä½œæµ‹è¯•**ï¼šPromise è¿”å›å€¼éªŒè¯
- âœ… **å¤šç›‘å¬å™¨æµ‹è¯•**ï¼šæ·»åŠ ã€ç§»é™¤ã€é‡å¤æ“ä½œ
- âœ… **åæ ‡è½¬æ¢æµ‹è¯•**ï¼šGPSã€ç™¾åº¦ã€è°·æ­Œç­‰åæ ‡ç³»è½¬æ¢

#### ExpoGaodeMapView
- âœ… åœ°å›¾è§†å›¾ç»„ä»¶æ¸²æŸ“
- âœ… ç›¸æœºæ§åˆ¶ï¼ˆç§»åŠ¨ã€ç¼©æ”¾ã€æ—‹è½¬ï¼‰
- âœ… åœ°å›¾æ“ä½œï¼ˆsetCenterã€setZoom ç­‰ï¼‰
- âœ… å¼•ç”¨æ–¹æ³•è°ƒç”¨

### è¦†ç›–ç‰©ç»„ä»¶æµ‹è¯•

æ‰€æœ‰è¦†ç›–ç‰©ç»„ä»¶éƒ½æœ‰ **100% æµ‹è¯•è¦†ç›–ç‡**ï¼š

- âœ… **Circle** - åœ†å½¢è¦†ç›–ç‰©
- âœ… **Marker** - æ ‡è®°ç‚¹
- âœ… **Polyline** - æŠ˜çº¿
- âœ… **Polygon** - å¤šè¾¹å½¢
- âœ… **HeatMap** - çƒ­åŠ›å›¾
- âœ… **Cluster** - ç‚¹èšåˆ
- âœ… **MultiPoint** - æµ·é‡ç‚¹

æ¯ä¸ªè¦†ç›–ç‰©æµ‹è¯•åŒ…æ‹¬ï¼š
- Props ä¼ é€’éªŒè¯
- äº‹ä»¶å¤„ç†æµ‹è¯•
- è¾¹ç•Œæƒ…å†µæµ‹è¯•

### å·¥å…·ç±»æµ‹è¯•

#### ErrorHandlerï¼ˆ100% è¦†ç›–ç‡ï¼‰
- âœ… 8 ç§é”™è¯¯ç±»å‹åˆ›å»º
- âœ… åŸç”Ÿé”™è¯¯è¯†åˆ«å’ŒåŒ…è£…
- âœ… é”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–
- âœ… æ—¥å¿—æ§åˆ¶åŠŸèƒ½

#### ModuleLoaderï¼ˆ100% è¦†ç›–ç‡ï¼‰
- âœ… æ¨¡å—åŠ è½½é€»è¾‘
- âœ… é”™è¯¯å¤„ç†

## ğŸ§ª è¿è¡Œæµ‹è¯•

### å®‰è£…ä¾èµ–

æµ‹è¯•æ¡†æ¶ä½¿ç”¨ Jest å’Œ React Native Testing Libraryï¼š

```bash
cd packages/core
pnpm install
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
pnpm test
```

### è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶

```bash
pnpm test ExpoGaodeMapModule
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
pnpm test --coverage
```

è¦†ç›–ç‡æŠ¥å‘Šå°†ç”Ÿæˆåœ¨ `coverage/` ç›®å½•ä¸‹ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `coverage/lcov-report/index.html` æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚

### ç›‘å¬æ¨¡å¼

```bash
pnpm test --watch
```

## ğŸ“ æµ‹è¯•ç¤ºä¾‹

### åŸºç¡€æµ‹è¯•ç¤ºä¾‹

```typescript
import ExpoGaodeMapModule from '../ExpoGaodeMapModule';

describe('ExpoGaodeMapModule', () => {
  it('åº”è¯¥æˆåŠŸåˆå§‹åŒ– SDK', async () => {
    await expect(
      ExpoGaodeMapModule.initSDK({
        androidKey: 'test-android-key',
        iosKey: 'test-ios-key',
      })
    ).resolves.toBeUndefined();
  });

  it('SDK æœªåˆå§‹åŒ–æ—¶åº”è¯¥æŠ›å‡ºé”™è¯¯', async () => {
    await expect(
      ExpoGaodeMapModule.start()
    ).rejects.toThrow('SDK_NOT_INITIALIZED');
  });
});
```

### ç»„ä»¶æµ‹è¯•ç¤ºä¾‹

```typescript
import React from 'react';
import { render } from '@testing-library/react-native';
import { Marker } from '../Marker';

describe('Marker', () => {
  it('åº”è¯¥æ­£ç¡®æ¸²æŸ“', () => {
    const { toJSON } = render(
      <Marker
        coordinate={{ latitude: 39.9, longitude: 116.4 }}
        title="æµ‹è¯•æ ‡è®°"
      />
    );
    expect(toJSON()).toMatchSnapshot();
  });

  it('åº”è¯¥ä¼ é€’æ­£ç¡®çš„ props', () => {
    const { getByTestId } = render(
      <Marker
        coordinate={{ latitude: 39.9, longitude: 116.4 }}
        title="æµ‹è¯•æ ‡è®°"
        testID="marker"
      />
    );
    
    const marker = getByTestId('marker');
    expect(marker.props.coordinate).toEqual({
      latitude: 39.9,
      longitude: 116.4
    });
  });
});
```

### é”™è¯¯å¤„ç†æµ‹è¯•ç¤ºä¾‹

```typescript
import { ErrorHandler, ErrorType, GaodeMapError } from '../ErrorHandler';

describe('ErrorHandler', () => {
  it('åº”è¯¥åˆ›å»º SDK æœªåˆå§‹åŒ–é”™è¯¯', () => {
    const error = ErrorHandler.sdkNotInitialized();
    
    expect(error).toBeInstanceOf(GaodeMapError);
    expect(error.type).toBe(ErrorType.SDK_NOT_INITIALIZED);
    expect(error.message).toContain('SDK å°šæœªåˆå§‹åŒ–');
    expect(error.solution).toContain('initSDK');
  });

  it('åº”è¯¥è¯†åˆ«å¹¶åŒ…è£…åŸç”Ÿé”™è¯¯', () => {
    const nativeError = new Error('Permission denied');
    const wrappedError = ErrorHandler.wrapNativeError(nativeError);
    
    expect(wrappedError.type).toBe(ErrorType.PERMISSION_DENIED);
  });
});
```

## ğŸ¯ æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

é’ˆå¯¹æ¯ä¸ªç‹¬ç«‹çš„æ¨¡å—å’Œç»„ä»¶ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿ï¼š
- å‡½æ•°é€»è¾‘æ­£ç¡®
- è¾¹ç•Œæ¡ä»¶å¤„ç†
- é”™è¯¯æƒ…å†µè¦†ç›–

### 2. ç»„ä»¶æµ‹è¯•

æµ‹è¯• React ç»„ä»¶çš„ï¼š
- æ¸²æŸ“æ­£ç¡®æ€§
- Props ä¼ é€’
- äº‹ä»¶å¤„ç†
- ç”Ÿå‘½å‘¨æœŸ

### 3. é›†æˆæµ‹è¯•

æµ‹è¯•æ¨¡å—é—´çš„äº¤äº’ï¼š
- æ¨¡å—é—´é€šä¿¡
- æ•°æ®æµè½¬
- é”™è¯¯ä¼ æ’­

### 4. é”™è¯¯åœºæ™¯æµ‹è¯•

ä¸“é—¨æµ‹è¯•å„ç§é”™è¯¯æƒ…å†µï¼š
- SDK æœªåˆå§‹åŒ–
- æƒé™è¢«æ‹’ç»
- ç½‘ç»œé”™è¯¯
- å‚æ•°é”™è¯¯

## ğŸ“ˆ æŒç»­æ”¹è¿›

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **å½“å‰**ï¼š75.7%ï¼ˆ207ä¸ªæµ‹è¯•ï¼‰
- **çŸ­æœŸç›®æ ‡**ï¼š80%+
- **é•¿æœŸç›®æ ‡**ï¼š85%+

### æµ‹è¯•è´¨é‡æå‡

è‡ªæœ€åˆç‰ˆæœ¬ä»¥æ¥çš„æ”¹è¿›ï¼š
- âœ… æµ‹è¯•æ•°é‡ä» **164 å¢åŠ åˆ° 207**ï¼ˆ+43ä¸ªæµ‹è¯•ï¼‰
- âœ… æ–°å¢**æ·±åº¦æµ‹è¯•**è¦†ç›–é”™è¯¯åœºæ™¯ã€è¾¹ç•Œå€¼ã€é…ç½®ç»„åˆ
- âœ… ExpoGaodeMapModule å‡½æ•°è¦†ç›–ç‡è¾¾åˆ° **91.66%**
- âœ… æ‰€æœ‰è¦†ç›–ç‰©ç»„ä»¶ä¿æŒ **96%+ è¦†ç›–ç‡**
- âœ… å·¥å…·ç±»ï¼ˆErrorHandlerã€ModuleLoaderï¼‰ä¿æŒ **100% è¦†ç›–ç‡**

### æ”¹è¿›è®¡åˆ’

1. **å¢åŠ è¾¹ç•Œæµ‹è¯•**
   - æç«¯å‚æ•°å€¼æµ‹è¯•
   - å¹¶å‘æ“ä½œæµ‹è¯•
   - å†…å­˜æ³„æ¼æµ‹è¯•

2. **ç«¯åˆ°ç«¯æµ‹è¯•**
   - æ·»åŠ  Detox é›†æˆæµ‹è¯•
   - çœŸæœºæµ‹è¯•åœºæ™¯
   - æ€§èƒ½åŸºå‡†æµ‹è¯•

3. **å¿«ç…§æµ‹è¯•**
   - ç»„ä»¶è§†è§‰å›å½’æµ‹è¯•
   - UI ä¸€è‡´æ€§éªŒè¯

## ğŸ” æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½å

ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°ï¼š

```typescript
// âŒ ä¸å¥½
it('test 1', () => {});

// âœ… å¥½
it('å½“ SDK æœªåˆå§‹åŒ–æ—¶è°ƒç”¨ start() åº”è¯¥æŠ›å‡ºé”™è¯¯', () => {});
```

### 2. å•ä¸€èŒè´£

æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªè¡Œä¸ºï¼š

```typescript
// âŒ ä¸å¥½ - æµ‹è¯•å¤šä¸ªè¡Œä¸º
it('åº”è¯¥åˆå§‹åŒ–å¹¶å¯åŠ¨å®šä½', async () => {
  await ExpoGaodeMapModule.initSDK({ ... });
  await ExpoGaodeMapModule.start();
});

// âœ… å¥½ - åˆ†å¼€æµ‹è¯•
it('åº”è¯¥æˆåŠŸåˆå§‹åŒ– SDK', async () => {
  await ExpoGaodeMapModule.initSDK({ ... });
});

it('åº”è¯¥æˆåŠŸå¯åŠ¨å®šä½', async () => {
  await ExpoGaodeMapModule.start();
});
```

### 3. ä½¿ç”¨ Mock

é€‚å½“ä½¿ç”¨ Mock éš”ç¦»ä¾èµ–ï¼š

```typescript
jest.mock('react-native/Libraries/EventEmitter/NativeEventEmitter');

const mockEmitter = new NativeEventEmitter();
mockEmitter.addListener = jest.fn();
```

### 4. æ¸…ç†å‰¯ä½œç”¨

æ¯ä¸ªæµ‹è¯•åæ¸…ç†çŠ¶æ€ï¼š

```typescript
afterEach(() => {
  jest.clearAllMocks();
});
```

## ğŸ› è°ƒè¯•æµ‹è¯•

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
pnpm test --verbose
```

### è°ƒè¯•ç‰¹å®šæµ‹è¯•

```bash
pnpm test --testNamePattern="SDK åˆå§‹åŒ–"
```

### ä½¿ç”¨ VSCode è°ƒè¯•å™¨

åœ¨ `.vscode/launch.json` ä¸­æ·»åŠ é…ç½®ï¼š

```json
{
  "type": "node",
  "request": "launch",
  "name": "Jest Debug",
  "program": "${workspaceFolder}/node_modules/.bin/jest",
  "args": ["--runInBand", "--no-cache"],
  "console": "integratedTerminal",
  "internalConsoleOptions": "neverOpen"
}
```

## ğŸ“š ç›¸å…³èµ„æº

- [Jest æ–‡æ¡£](https://jestjs.io/)
- [React Native Testing Library](https://callstack.github.io/react-native-testing-library/)
- [æµ‹è¯•æœ€ä½³å®è·µ](https://kentcdodds.com/blog/common-mistakes-with-react-testing-library)

## ğŸ’¡ è´¡çŒ®æµ‹è¯•

æ¬¢è¿è´¡çŒ®æ›´å¤šæµ‹è¯•ç”¨ä¾‹ï¼è¯·éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. ä¿æŒæµ‹è¯•ç®€å•æ˜äº†
2. ç¡®ä¿æµ‹è¯•å¯é‡å¤è¿è¡Œ
3. ç¼–å†™æœ‰æ„ä¹‰çš„æ–­è¨€
4. æ·»åŠ å¿…è¦çš„æ³¨é‡Š
5. ä¿æŒæµ‹è¯•è¦†ç›–ç‡ä¸é™ä½

æäº¤ PR æ—¶ï¼Œè¯·ç¡®ä¿ï¼š
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… æµ‹è¯•è¦†ç›–ç‡ä¸é™ä½
- âœ… ä»£ç ç¬¦åˆ ESLint è§„èŒƒ

## ğŸ“ æµ‹è¯•æ–‡åŒ–

æˆ‘ä»¬ç›¸ä¿¡**é«˜è´¨é‡çš„æµ‹è¯•æ˜¯é«˜è´¨é‡ä»£ç çš„ä¿éšœ**ã€‚æ¯ä¸ªåŠŸèƒ½éƒ½åº”è¯¥æœ‰å¯¹åº”çš„æµ‹è¯•ï¼Œè¿™ä¸ä»…èƒ½ï¼š

- ğŸ”’ é˜²æ­¢å›å½’é—®é¢˜
- ğŸ“– ä½œä¸ºä»£ç æ–‡æ¡£
- ğŸš€ æé«˜é‡æ„ä¿¡å¿ƒ
- ğŸ› å¿«é€Ÿå®šä½é—®é¢˜
- âœ¨ æ”¹å–„ä»£ç è®¾è®¡

è®©æˆ‘ä»¬ä¸€èµ·ç»´æŠ¤å’Œæå‡é¡¹ç›®çš„æµ‹è¯•è´¨é‡ï¼